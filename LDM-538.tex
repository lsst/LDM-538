\documentclass[DM,lsstdraft,STS,toc]{lsstdoc}
% lsstdoc documentation: https://lsst-texmf.lsst.io/lsstdoc.html
% Package imports go here.

\usepackage{enumitem}
\begin{document}
\def\product{LSST DM Raw Image Archiving Service}
\setDocCompact{true}
\author{Michelle Butler, Jim Parsons, Michelle Gower }
\setDocDate{\vcsdate}
\setDocRef{LDM-538}


\date{\today}


% Change history defined here.
\setDocChangeRecord{%
\addtohist{}{2018-04-18}{initial release - draft version}{Michelle Butler}
}


\title[Test Spec for \product]{\product~Test Specification}




\setDocAbstract {
This document describes the detailed test specification for the
\product{}. This is a specific DM test, and will grow as more tests
are needed for the entire environment. This includes two individual
tests for the overall raw image creation and ingest into the permanent
record of the survey.
}


\setDocUpstreamLocation{\url{https://github.com/lsst/ldm-538}}
% \setDocUpstreamVersion{\vcsrevision}


\maketitle


\section{Introduction}
\label{sec:intro}


This document specifies the test procedure for the \product{}.


The \product{} is the component of the LSST system which is responsible for:
\begin{itemize}
\item{The creation of a well-formed raw image;}
\item{Providing fast access to the raw image by the Observatory Operations staff;}
\item{Saving the raw image into the permanent record of the survey;}
\end{itemize}


A full description of this service is provided in \S5.1.1 of \citeds{LDM-148}
and \S2.2 (which describes LSSTCam Archiving Service),
\S2.3 (Spectrograph Archiving Service) and
\S2.6 (Observatory Operations Data Service) of \citeds{LDM-230}.




\subsection{Objectives}
\label{sec:objectives}




This document builds on the description of LSST Data Management's
approach to testing as described in \citeds{LDM-503} to describe
the detailed tests that will be performed on the \product{} as part
of the verification of the DM system.


It identifies test designs, test cases and procedures for the tests,
and the pass/fail criteria for each test.

\subsection{Definitions, Acronyms, and Abbreviations \label{sec:acronyms}}
\input{acronyms}

\subsection{Scope}
\label{sec:scope}


This document describes the test procedures for the Raw Image Archiving Service
which includes parts from each of the following components of the LSST system
(as described in \citeds{LDM-148}):


\begin{itemize}

\item{OCS}
\item{Camera DAQ}
\item{DM Header Service}
\item{EFD Large File Annex (limited to communication between the DM Header Service and the Archivers)}
\item{DM OCS Bridge}
\item{DMCS}
\item{Archiver}
\item{Catch-up Archiver}
\item{Alert Processor}
\item{ATS Achiver}
\item{Data Forwarders}
\item{Observatory Operations Data Service}
\item{Data Backbone Services}


\end{itemize}


\subsection{Applicable Documents}
\label{sec:docs}


\addtocounter{table}{-1}


\begin{tabular}[htb]{l l}


\citeds{LSE-209} & Software Component to Observatory Control System (OCS) Interface \\
% \citeds{LSE-73} & Observatory Control System (OCS) to Telescope Software Communication Interface \\
\citeds{LSE-68} & Camera Data Acquisition Interface \\
\citeds{LSE-70} & System Communication Protocol Interface \\
\citeds{LSE-72} & Data Management - OCS Software Communication Interface \\
\citeds{LDM-148} & LSST DM System Architecture \\
\citeds{LDM-294} & LSST DM Organization \& Management \\
\citeds{LDM-503} & LSST DM Test Plan \\
\citeds{LSE-61} & LSST DM Subsystem Requirements \\
\citeds{LSE-163} & LSST Data Products Definition Document \\
\citeds{LSE-29} & LSST Data Products Definition Document \\


\end{tabular}


\subsection{References\label{sec:references}}
\renewcommand{\refname}{}
\bibliography{lsst,refs,books,refs_ads}




%----------------------------------------------------
% TASK IDENTIFICATION - APPROACH
%----------------------------------------------------
\section{Approach}
\label{sec:approach}


The major activities to be performed are to:
\begin{itemize}
\item{Show successful integration between Telescope subsystems and L1 Archiver Service;}
\item{Show successful integration between L1 Archiver Service and OODS;}
\item{Show successful integration between L1 Archiver Service and DBB;}
\end{itemize}


\subsection{Tasks and criteria}
\label{sec:tasks}


The following are the major items under test:


\begin{itemize}
\item{Create a well-formed raw image with data acquired from the Camera DAQ and the DM Header Service; }
\item{Save a raw image in the OODS cache and access it using normal LSST mechanisms (e.g., ``Data Butler''); }
\item{Ingest a raw image into the DBB; }
\end{itemize}




\subsection{Features to be tested}
\label{sec:feat2test}


Do the following satisfy the requirements described in \citeds{LSE-61}?
\begin{itemize}
\item{Completeness and correctness of the raw images including format, metadata, and image data;}
\item{Raw data access;}
\item{Archiving of raw images;}
\end{itemize}


\subsection{Features not to be tested}
\label{sec:featnot2test}


This document describes the end-to-end testing of various components
that comprise the Raw Image Archiving service. It does not include tests internal to
a single component. Also this test specification does not
extend beyond the positive pass/fail options.

\subsection{Pass/fail criteria}
\label{sec:passfail}


The results of all tests will be assessed using the criteria described in
\citeds{LDM-503} \S4.




\subsection{Suspension criteria and resumption requirements}
\label{suspension}


Refer to individual test cases where applicable.


%----------------------------------------------------
% TASK IDENTIFICATION - Test Specification Design
%----------------------------------------------------
\section{Test Specification Design}
\label{sec:Test Specification Design}
\subsection{RAS-00: Raw Image Archive Service}


\subsubsection{Objective}
This test specification demonstrates the successful writing of a
well-formed raw image to the permanent record of the survey and
for rapid access for Observatory Operations staff.


\subsubsection{Test case identification}


\begin{longtable} {|p{0.4\textwidth}|p{0.6\textwidth}|}\hline
\textbf{Test Case} & \textbf{Description} \\\hline
\hyperref[ras-00-00]{RAS-00-00} & Tests that well-formed raw image can be written \\\hline
\hyperref[ras-00-10]{RAS-00-10} & Tests that the raw image can be accessed via the OODS \\\hline
\hyperref[ras-00-20]{RAS-00-20} & Tests that the raw image has been archived in the DBB \\\hline
\hyperref[ras-00-30]{RAS-00-30} & Overall testing of availability, throughput, reliability, and heterogeneity \\\hline
\end{longtable}


\section{Test Case Specification}


%----------------------------------------------------
\subsection{RAS-00-00: Writing well-formed raw image}
\label{ras-00-00}


\subsubsection{Requirements}

\begin{itemize}
\item{DMS-REQ-0018}
\item{DMS-REQ-0020}
\item{DMS-REQ-0265}
\item{DMS-REQ-0068}
\item{DMS-REQ-0024}
\item{DMS-REQ-0315}
\item{DMS-REQ-0284 (limited to the completeness of raw image creation)}
\end{itemize}


\subsubsection{Test items}
This test will check:


\begin{itemize}
\item{The successful integration of the Pathfinder components with the DM Header Service and the L1 Archiver;}
\item{That the raw images are well-formed and meet specifications in change-controlled documents \citeds{LSE-61};}
\end{itemize}


\subsubsection{Intercase dependencies}
\begin{itemize}
\item{None}
\end{itemize}


\subsubsection{Environmental needs}
\paragraph{Hardware}
\begin{itemize}
\item{L1 test stand}
\item{Test machine for LSST Monitoring Service}
\end{itemize}


\paragraph{Software}
\begin{itemize}
\item{L1 software and services needed to create raw image}
\item{LSST Monitoring Service and plugins specific to monitoring L1 Test Stand and services}
\end{itemize}


\subsubsection{Input specification}
None
\subsubsection{Output specification}
\begin{itemize}
\item{Raw image(s) that follow specifications defined in change-controlled document \citeds{LSE-61};}
\end{itemize}


\subsubsection{Procedure}
Repeat the following steps for each of the different cameras (ATScam, LSSTCam) and sensors (Science, Wavefront, and Guider):
\begin{itemize}
\item{Configure system to pull appropriate data from the DAQ emulator;}
\item{Acquire raw data from DAQ readout and DMHS;}
\item{Fetch data and reassemble correctly, regardless of CCD/Sensor manufacturer type (two different types will be used);}
\item{Check Completeness and correctness of the raw images including format, metadata, and image data;}
\begin{itemize}
\item{Check proper fetch and reassembly of image data from camera DAQ (correct format and data);}
\item{Check proper merge of header service data with image data;}
\item{Check correct insertion of exposure specific data needed in the data file that is not supplied by header service;}
\item{Check minimum required metadata (from requirements document \citeds{LSE-61}) exists in raw image header;}
\end{itemize}
\item{Check that the checksum of the file matches the previously calculated value that will be passed on to downstream services;}
\item{Check confirmation that the data files arrive at their destination intact;}
\item{Check that LSST Monitoring Service showed the appropriate information successfully;}
\end{itemize}



%----------------------------------------------------
\subsection{RAS-00-10: Raw images in Observatory Operations Data Service}
\label{ras-00-10}
\subsubsection{Requirements}
Requirements for the OODS
\begin{itemize}
\item{DMS-REQ-0346}
\end{itemize}


\subsubsection{Test items}
This test will check:
\begin{itemize}
\item{The handoff of a raw image from the L1 Archiver to the OODS cache manager is successful;}
\item{A recently taken raw image is accessible to the Observatory Operations staff at the base and summit;}
\end{itemize}


\subsubsection{Intercase dependencies}
\begin{itemize}
\item{\hyperref[ras-00-00]{RAS-00-00}}
\end{itemize}


\subsubsection{Environmental needs}
\paragraph{Hardware}


To complete all tests in a manner which reflects the real system,
the following hardware is needed.  Note: If not testing inter-machine access, the hardware can be minimized to a single machine outside of the L1 Test Stand.


\begin{itemize}
\item{L1 Test Stand (include hardware from \hyperref[ras-00-00]{RAS-00-00}) + read/write access to OODS cache disk}
\item{Test Machine for OODS cache manager with read/write access to OODS cache disk}
\item{Test machine for Observatory Operations staff at "base" that can access OODS cache disk}
\item{Test machine for Observatory Operations staff at "summit" that can access OODS cache disk}
\item{Test machine for LSST Monitoring Service}
\end{itemize}


Size of cache disk is determined by number of files to be included in the test.






\paragraph{Software}


The following software must be installed:
\begin{itemize}
\item{L1 Test Stand (include software from \hyperref[ras-00-00]{RAS-00-00})}
\item{OODS cache manager}
\item{LSST Monitoring Service and plugins specific to monitoring raw images and OODS}
\item{LSST stack for checking raw images}
\end{itemize}




\subsubsection{Input specification}


None.


\subsubsection{Output specification}
\begin{itemize}
\item{Raw image(s) that follow format defined in \citeds{LSE-61};}
\item{Database (may be sqlite file) that enables the raw image(s) to be accessed via a ``Data Butler'';}
\end{itemize}


\subsubsection{Procedure}
Repeat the following steps for each of the different cameras (ATScam, LSSTCam) and sensors (Science, Wavefront, and Guider):
\begin{itemize}
\item{Initialize all services configuring the L1 Archiver Service so that the raw images are to be saved to the OODS;}
\item{Acquire a raw image (see \hyperref[ras-00-00]{RAS-00-00});}
\item{The handoff of the raw image from the L1 Archiver Service to the test OODS automatically occurs;}
\item{For each of the expected raw images, verify that the checksum matches the original L1 checksum;}
\item{The DM Stack shall be initialized using the \texttt{loadLSST} script;}
\item{A ``Data Butler'' will be initialized to access the raw image repository in the OODS cache;}
\item{For each of the expected raw images, the file will be retrieved from the ``Data Butler'' showing accessibility via the OODS;}
\item{Check that LSST Monitoring Service showed the appropriate information successfully;}
\end{itemize}




%----------------------------------------------------
\subsection{RAS-00-20: Raw images are part of permanent record of survey via DBB}
\label{ras-00-20}


\subsubsection{Requirements}


\begin{itemize}
\item{DMS-REQ-0068}
\item{DMS-REQ-0346}
\item{DMS-REQ-0284 (limited to the raw image archiving completeness)}
\end{itemize}


\subsubsection{Test items}


This test will check:
\begin{itemize}
\item{That the handoff of a raw image from the L1 Archiver Service to the DBB buffer
manager is successful;}
\item{That the raw image is ingested into the Data Backbone successfully;}
\item{That the monitoring of the above items is successful;}
\end{itemize}


Note: For a complete check of the various aspects of what it means for
a raw image to be in the Data Backbone, see the tests for the Data Backbone.

\subsubsection{Intercase dependencies}
\begin{itemize}
\item{\hyperref[ras-00-00]{RAS-00-00}}
\end{itemize}


\subsubsection{Environmental needs}
\paragraph{Hardware}
\begin{itemize}
\item{L1 Test Stand (include hardware from \hyperref[ras-00-00]{RAS-00-00}) + read/write access to DBB buffer disk;}
\item{Test Machine for DBB buffer manager with read/write access to DBB buffer disk;}
\item{Test machine for each DBB endpoint with read/write access to DBB disk;}
\item{Test machine for LSST Monitoring Service;}
\end{itemize}


Size of buffer disk and DBB disk is determined by number of files to be included in the test.


Note: If not testing inter-machine operability, then the hardware can be minimized
to a single machine outside of the L1 test stand.


\paragraph{Software}
\begin{itemize}
\item{L1 Test Stand}
\item{DBB buffer manager}
\item{DBB raw image ingestion}
\item{DBB database}
\item{LSST Monitoring Service and plugins specific to monitoring raw images, DBB buffer manager, and DBB}
\end{itemize}




\subsubsection{Input specification}
None


\subsubsection{Output specification}
\begin{itemize}
\item{Raw image(s) are saved to storage and replicated to correct locations with checksums that match
original L1 checksum;}
\item{Database containing information of the following types: physical, location, science metadata,
provenance as specified in \citeds{LSE-61};}
\item{Both image(s) and database entries replicated correctly;}
\end{itemize}


\subsubsection{Procedure}
Repeat the following steps for each of the different cameras (ATScam, LSSTCam) and sensors (Science, Wavefront, and Guider):
\begin{itemize}
\item{Initialize all services configuring the L1 Archiver Service so that the raw images are to be archived to the DBB;}
\item{Acquire a raw image (see \hyperref[ras-00-00]{RAS-00-00});}
\item{After the automatic handoff of the raw image between the L1 Archiver Service and the DBB buffer manager, the raw
image will automatically be ingested into the Test Data Backbone;}
\item{Check that the raw image is accessible at each test DBB endpoint and matches original L1 checksum;}
\item{Check that LSST Monitoring Service showed the appropriate information successfully;}
\item{More complete tests of the DBB can be done by running the DBB
service tests on the raw image(s). These would check correctness
and completeness of the data stored in the database as well as
checking that the file has been replicated to all required places;}
\end{itemize}


%----------------------------------------------------
\subsection{RAS-00-30: Raw Image Archiving Availability, Throughput, Reliability, and Heterogeneity}
\label{ras-00-30}

\subsubsection{Requirements}
\begin{itemize}
\item{DMS-REQ-0346}
\item{DMS-REQ-0008}
\item{DMS-REQ-0162}
\item{DMS-REQ-0165}
\item{DMS-REQ-0167}
\item{DMS-REQ-0314}
\item{DMS-REQ-0318}
\item{DMS-REQ-0309}
\end{itemize}

\subsubsection{Test items}


This test will check:
\begin{itemize}
\item{Raw Image Archiving meets availability requirements;}
\item{Raw Image Archiving meets throughput requirements;}
\item{Raw Image Archiving meets reliability requirements;}
\item{Raw Image Archiving meets heterogeneity requirements;}
\end{itemize}

\subsubsection{Intercase dependencies}
\begin{itemize}
\item{\hyperref[ras-00-00]{RAS-00-00}}
\item{\hyperref[ras-00-00]{RAS-00-10}}
\item{\hyperref[ras-00-00]{RAS-00-20}}
\end{itemize}

\subsubsection{Procedure}
\begin{itemize}
\item{For each of the requirements to be tested, run the test on each individual component;}
\item{For DMS-REQ-0167, where there is a handoff between the major components in the Raw Image Archiving Service,
repeat the tests \hyperref[ras-00-00]{RAS-00-10} and \hyperref[ras-00-00]{RAS-00-20} failing a major component;}
\item{For end-to-end tests that include downstream services/components, refer to the downstream
service/component test specifications;}
\end{itemize}

\end{document}
