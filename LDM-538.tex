\documentclass[DM,lsstdraft,STS,toc]{lsstdoc}

% lsstdoc documentation: https://lsst-texmf.lsst.io/lsstdoc.html

% Package imports go here.
\usepackage{enumitem}
\input meta.tex
% Local commands go here.

% To add a short-form title:
% \title[Short title]{Title}
\title{Data Management L1 Enclaves Test Specification}

% Optional subtitle
% \setDocSubtitle{A subtitle}

\author{%
Michelle Butler, Jim Parsons, Michelle Gower 
}

\setDocRef{LDM-538}

\date{\today}

% Optional: name of the document's curator
% \setDocCurator{Michelle Butler}

\setDocAbstract{%
This is the test specifications for LDM-503-3 and LDM503-4b.   These are the tests of the trigger of the camera to produce a fits file with proper headers, and then taking one of those images and placing it into the data back bone (DBB).  
}

% Change history defined here.
% Order: oldest first.
% Fields: VERSION, DATE, DESCRIPTION, OWNER NAME.
% See LPM-51 for version number policy.
\setDocChangeRecord{%
  \addtohist{1}{2018-04-18}{initial release - draft version}{Michelle Butler }
}

\begin{document}
\def\product{DM L1 Enclaves}
\setDocCompact{true}


\title[Test Spec for \product]{\product~Test Specification}

\setDocRef{\lsstDocType-\lsstDocNum}
\setDocDate{\vcsdate}

\setDocAbstract {
This document describes the detailed test specification for the \product{}.
}

\setDocUpstreamLocation{\url{https://github.com/lsst/ldm-538}}
\setDocUpstreamVersion{\vcsrevision}

\maketitle

\section{Introduction}
\label{sec:intro}

This document specifies the test procedure for the \product{}.

The \product{} is the component of the LSST system which is triggering the camera which then leads to: 
\begin{itemize}

  \item{Gathering the data; }
  \item{Storing the data in a collection location;}
  \item{Notifing the Data Back Bone (DBB) that a file has been created;}
  \item{DBB stores the files including the providence and the MD5 sums for future reference}

\end{itemize}


\subsection{Objectives}
\label{sec:objectives}


This document builds on the description of LSST Data Management's approach to
testing as described in \citeds{LDM-503} to describe the detailed tests that
will be performed on the \product{} as part of the verification of the DM system.

It identifies test designs, test cases and procedures for the tests, and the
pass/fail criteria for each test.

\subsection{Scope}
\label{sec:scope}

This document describes the test procedures for the following components of
the LSST system (as described in \citeds{LDM-148}):

\begin{itemize}

  \item{L1 DAQ trigger and write out FITS files with providence  }

  \item{DBB retrieve from from L! and ingest into filesystem }

\end{itemize}

\subsection{Applicable Documents}
\label{sec:docs}

\addtocounter{table}{-1}

\begin{tabular}[htb]{l l}
\citeds{LDM-148} & LSST DM System Architecture \\
\citeds{LSE-230} & ??  \\

\end{tabular}
LSE-230, LSE-72, LSE-73, LSE-68, and LSE-70. 
LSE-230, LSE-72, LSE-73, LSE-68, and LSE-70

\subsection{References\label{sect:references}}
\renewcommand{\refname}{}
\bibliography{lsst,refs,books,refs_ads}

%\subsection{Definitions, acronyms, and abbreviations \label{sect:acronyms}} % include acronyms.tex generated by the acronyms.csh (GaiaTools)
%\input{acronyms}


%----------------------------------------------------
% TASK IDENTIFICATION - APPROACH
%----------------------------------------------------
\section{Approach}
\label{sec:approach}

The major activities to be performed are to:

\begin{itemize}

  \item{Spectrograph Image Data Fetch from DAQ. Integration of Image Data with header metadata from the DM Header Service (DMHS), producing FITS files. This test is a lead up test to a Pathfinder Activity to be held on Feb. 26th, 2018 referred to as the Daq-to-DM Files exercise. It will also use the OCS and CCS as well as the DMHS and the DM. It will insures that DAQ data can be fetched and properly integrated with header service output when all of the vendors are involved.}

 
\end{itemize}

\subsection{Tasks and criteria}
\label{sec:tasks}

The following are the major items under test:

\begin{itemize}

  \item{Daq-to-DM Files.  It will insures that DAQ data can be fetched and properly integrated with header service output ;}

 

\end{itemize}

\subsection{Features to be tested}
\label{sec:feat2test}

\begin{itemize}

  \item{Header service and l1 ATS device will be started and state to enable;}
  \item{Header service and L1 DM system respond with correct messages;}
  \item{Take images and deposit well formed FITS files at a file landing facility within the L1 Archive Controller component.   Prices locations is configurable within the system wide L1SystemCfg.yaml file.}

\end{itemize}


\subsection{Pass/fail criteria}
\label{sec:passfail}

The results of all tests will be assessed using the criteria described in
\citeds{LDM-503} \S4.

Note that, when executing pipelines, tasks or individual algorithms, any
unexplained or unexpected errors or warnings appearing in the associated log
or on screen output must be described in the documentation for the system
under test. Any warning or error for which this is not the case must be filed
as a software problem report and filed with the DMCCB.

\subsection{Suspension criteria and resumption requirements}
\label{suspension}

Refer to individual test cases where applicable.
-----------------
======================================================
Test Spec

Note: Once the files have been ingested into the DBB, full tests of the 
   Data Backbone services can be run for more thorough
   checks.    See Data Backbone Services tests for details.    

Procedure:
* If not already available, set up test machines,
  services, accounts (ITC)
    * DBB gateway client machine that can see files output by L1 archiver
    * DBB gateway server machine that has:
        * File transfer service
        * Delivery area
        * Write access to Data Backbone filesystem(s)
    * Database with apropriate schema
    * Authentication to file transfer service and database using LSST AA(?) service.

* Install and configure software
    * DBB Gateway client machine - dbb\_gwclient and prereqs
    * DBB Gateway server machine - dbb\_gateway and prereqs

* If not already running, start test services
    * (L1 test stand services)
    * DBB Gateway
    * Monitoring

* The L1 test stand is triggered to save 1 or more raw fits files.

* After the test L1 archiver has output files,
  the DBB gateway client will stage the files plus appropriate
  information to the test DBB gateway.

* The test DBB Gateway service will automatically
  ingest the staged file into the test DBB which
  includes saving appropriate location, physical, science,
  and provenance information to the database.   Spot check data 
  in the database and the DBB filesystem or run DBB tests.

* The test DBB services will automatically ensure that
  copies of the files go to the right DBB locations as well
  as in disaster recovery.    Spot check files are in the correct 
  locations or run DBB tests.
 
* Run spot checks to ensure meet accessibility requirements or
 run DBB tests.


======================================================================
Test Report

Test systems used:
* The DBB Gateway client was run on user's workstation with no
direct access to the L1 test stand outputs.
* The DBB Gateway service was run on a temporary virtual machine
running HTTPS/webdav.
* The DBB database was a single-node Oracle system.

Differences in procedure for 503-4b:
* (The test file was manually created by Felipe instead of the L1
test stand.)
* The test file was manually copied to a non-L1 test stand machine
to continue rest of test.
* The test DBB gateway client is manually executed.  Integration
work to automate the process is future milestone.  It is expected
* The test DBB Gateway service was also manually executed.
* Since both ends of the process was run by user, only testing user
authentication (as opposed to service accounts)
* The test DBB Gateway service stores no science information in the
DB.  Temporary code in place waiting for Gen3 Butler.
* There was a single site, single copy with no disaster recovery.
* There was no monitoring.
* Did manual checks inside the DBB.

Results:
Within the restrictions for this milestone, the test was successful.
Following the modified test procedure with the available hardware,
an ATS raw file along with information including user and md5sum were
sent via HTTPs to the delivery area on the DBB gateway machine where
another program was executed to copy the raw file to the appropriate
test DBB directory as well as save information to the DBB database
tables.
-------------------

%\input{specs/specs.tex}
%\input{cases/cases.tex}

\appendix

\section{The Hyper Suprime-Cam ``RC'' datasets}

\subsection{RC1}

The original HSC ``release candidate'' dataset was defined as part of testing
release 3.9.0 of the HSC pipeline (derived from the LSST DM Stack). It
consists of 237 visits to the HSC ultra-deep Cosmos field and 83 visits to the
HSC wide survey. Specifically, this includes the following
visits\footnote{Defined using the standard LSST command-line task syntax}:

\subsubsection{Ultra-deep Cosmos}
\label{sec:hscrc1}

\begin{description}

\item[HSC-G]{\hfill \\ 11690..11712:2\^{}29324\^{}29326\^{}29336\^{}29340\^{}29350\^{}29352}
\item[HSC-R]{\hfill \\ 1202..1220:2\^{}23692\^{}23694\^{}23704\^{}23706\^{}23716\^{}23718}
\item[HSC-I]{\hfill \\ 1228..1232:2\^{}1236..1248:2\^{}19658\^{}19660\^{}19662\^{}19680\^{}19682\^{}19684\^{}\\19694\^{}19696\^{}19698\^{}19708\^{}19710\^{}19712\^{}30482..30504:2}
\item[HSC-Y]{\hfill \\ 274..302:2\^{}306..334:2\^{}342..370:2\^{}1858..1862:2\^{}1868..1882:2\^{}11718..11742:2\^{}22602..\\22608:2\^{}22626..22632:2\^{}22642..22648:2\^{}22658..22664:2}
\item[HSC-Z]{\hfill \\ 1166..1194:2\^{}17900..17908:2\^{}17926..17934:2\^{}17944..17952:2\^{}17962\^{}28354..28402:2}
\item[NB0921]{\hfill \\ 23038..23056:2\^{}23594..23606:2\^{}24298..24310:2\^{}25810..25816:2}

\end{description}

\subsubsection{Wide}

\begin{description}

\item[HSC-G]{\hfill \\ 9852\^{}9856\^{}9860\^{}9864\^{}9868\^{}9870\^{}9888\^{}9890\^{}9898\^{}9900\^{}9904\^{}9906\^{}9912\^{}11568\^{}\\11572\^{}11576\^{}11582\^{}11588\^{}11590\^{}11596\^{}11598}
\item[HSC-R]{\hfill \\ 11442\^{}11446\^{}11450\^{}11470\^{}11476\^{}11478\^{}11506\^{}11508\^{}11532\^{}11534}
\item[HSC-I]{\hfill \\ 7300\^{}7304\^{}7308\^{}7318\^{}7322\^{}7338\^{}7340\^{}7344\^{}7348\^{}7358\^{}7360\^{}7374\^{}7384\^{}7386\^{}\\19468\^{}19470\^{}19482\^{}19484\^{}19486}
\item[HSC-Y]{\hfill \\ 6478\^{}6482\^{}6486\^{}6496\^{}6498\^{}6522\^{}6524\^{}6528\^{}6532\^{}6544\^{}6546\^{}6568\^{}13152\^{}13154}
\item[HSC-Z]{\hfill \\ 9708\^{}9712\^{}9716\^{}9724\^{}9726\^{}9730\^{}9732\^{}9736\^{}9740\^{}9750\^{}9752\^{}9764\^{}9772\^{}9774\^{}\\17738\^{}17740\^{}17750\^{}17752\^{}17754}

\end{description}

\end{document}

% Include all the relevant bib files.
% https://lsst-texmf.lsst.io/lsstdoc.html#bibliographies
\bibliography{lsst,lsst-dm,refs_ads,refs,books}

\end{document}
